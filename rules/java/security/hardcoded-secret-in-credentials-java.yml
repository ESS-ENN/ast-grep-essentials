id: hardcoded-secret-in-credentials-java
language: java
severity: warning
message: >-
  A secret is hard-coded in the application. Secrets stored in source
  code, such as credentials, identifiers, and other types of sensitive data,
  can be leaked and used by internal or external malicious actors. Use
  environment variables to securely provide credentials and other secrets or
  retrieve them from a secure vault or Hardware Security Module (HSM).
note: >-
  [CWE-798]: Use of Hard-coded Credentials
  [OWASP A07:2021]: Identification and Authentication Failures
  [REFERENCES]
      - https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
utils:
  match_local_variable_declaration_with_username:
    kind: local_variable_declaration
    all:
      - has:
          stopBy: end
          kind: type_identifier
          field: type
      - has:
          stopBy: end
          kind: variable_declarator
          field: declarator
          has:
            stopBy: end
            kind: identifier
            field: name
      - has:
          stopBy: end
          kind: method_invocation
          all:
            - has:
                stopBy: end
                kind: identifier
                field: object
                regex: "^Credentials$"
            - has:
                stopBy: end
                kind: identifier
                field: name
                regex: "^basic$"
            - has:
                stopBy: end
                kind: argument_list
                field: arguments
                all:
                  - has:
                      stopBy: end
                      kind: identifier
                      pattern: $USERNAME
                  - has:
                      kind: string_literal
                      pattern: $STRING
    inside:
      stopBy: end
      kind: method_declaration
      follows:
        stopBy: end
        kind: field_declaration
        all:
          - has:
              stopBy: end
              kind: modifiers
          - has:
              stopBy: end
              kind: type_identifier
              field: type
          - has:
              stopBy: end
              kind: variable_declarator
              field: declarator
              all:
                - has:
                    stopBy: end
                    kind: identifier
                    field: name
                    pattern: $USERNAME
                - has:
                    stopBy: end
                    kind: string_literal
                    field: value
  match_local_variable_declaration_with_instance:
    kind: local_variable_declaration
    all:
      - has:
          stopBy: end
          kind: type_identifier
          field: type
      - has:
          stopBy: end
          kind: variable_declarator
          field: declarator
          all:
            - has:
                stopBy: end
                kind: identifier
                field: name
            - has:
                stopBy: end
                kind: method_invocation
                all:
                  - has:
                      stopBy: end
                      kind: identifier
                      field: object
                      regex: "^Credentials$"
                  - has:
                      stopBy: end
                      kind: identifier
                      field: name
                      regex: "^basic$"
            - has:
                stopBy: end
                kind: argument_list
                all:
                  - has:
                      stopBy: end
                      kind: identifier
                      pattern: $USERNAME
                      nthChild: 1
                  - has:
                      stopBy: end
                      kind: identifier
                      pattern: $PASS
                      nthChild: 2
                  - not:
                      has:
                        stopBy: end
                        kind: identifier
                        nthChild: 3
      - all:
          - inside:
              stopBy: end
              kind: method_declaration
              follows:
                stopBy: end
                kind: field_declaration
                all:
                  - has:
                      stopBy: end
                      kind: modifiers
                  - has:
                      stopBy: end
                      kind: type_identifier
                  - has:
                      stopBy: end
                      kind: variable_declarator
                      field: declarator
                      all:
                        - has:
                            stopBy: end
                            kind: identifier
                            field: name
                            pattern: $PASS
                        - has:
                            stopBy: end
                            kind: string_literal
                            field: value
                            pattern: $STRING
          - inside:
              stopBy: end
              kind: method_declaration
              follows:
                stopBy: end
                kind: field_declaration
                all:
                  - has:
                      stopBy: end
                      kind: modifiers
                  - has:
                      stopBy: end
                      kind: type_identifier
                  - has:
                      stopBy: end
                      kind: variable_declarator
                      field: declarator
                      all:
                        - has:
                            stopBy: end
                            kind: identifier
                            field: name
                            pattern: $USERNAME
                        - has:
                            stopBy: end
                            kind: string_literal
                            field: value
rule:
  any:
    - matches: match_local_variable_declaration_with_username
    - matches: match_local_variable_declaration_with_instance
constraints:
  STRING:
    not:
      regex: ^""$
