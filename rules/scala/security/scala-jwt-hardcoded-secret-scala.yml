id: scala-jwt-hardcoded-secret-scala
severity: warning
language: scala
message: >-
  Hardcoded JWT secret or private key is used. This is a Insufficiently
  Protected Credentials weakness:
  https://cwe.mitre.org/data/definitions/522.html Consider using an
  appropriate security mechanism to protect the credentials (e.g. keeping
  secrets in environment variables).
note: >-
  [CWE-522] Insufficiently Protected Credentials.
  [REFERENCES]
      - https://owasp.org/Top10/A04_2021-Insecure_Design
utils:
  Algorithm.HMAC("..."):
    kind: call_expression
    all:
      - has:
          stopBy: neighbor
          kind: field_expression
          all:
            - has:
                stopBy: neighbor
                kind: identifier
                regex: ^Algorithm$
            - has:
                stopBy: neighbor
                kind: identifier
                regex: '^HMAC256|HMAC384|HMAC512$'
      - has:
          stopBy: neighbor
          kind: arguments
          has:
            stopBy: neighbor
            kind: string
            pattern: $S
      - inside:
          stopBy: end
          kind: compilation_unit
          has:
            stopBy: end
            kind: import_declaration
            pattern: import com.auth0.jwt.algorithms.Algorithm
  Algorithm.HMAC($VAR):
    kind: call_expression
    all:
      - has:
          stopBy: neighbor
          kind: field_expression
          all:
            - has:
                stopBy: neighbor
                kind: identifier
                regex: ^Algorithm$
            - has:
                stopBy: neighbor
                kind: identifier
                regex: '^HMAC256|HMAC384|HMAC512$'
      - has:
          stopBy: neighbor
          kind: arguments
          has:
            stopBy: neighbor
            kind: identifier
            pattern: $A
      - inside:
          stopBy: end
          kind: compilation_unit
          has:
            stopBy: end
            kind: import_declaration
            pattern: import com.auth0.jwt.algorithms.Algorithm
      - inside:
         stopBy: end
         kind: function_definition
         follows:
          stopBy: end
          kind: val_definition
          all:
            - has:
                stopBy: end
                kind: identifier
                pattern: $A
            - has:
                stopBy: neighbor
                kind: string
                field: value
                pattern: $S
rule:
  kind: call_expression
  any:
    - matches: Algorithm.HMAC("...")
    - matches: Algorithm.HMAC($VAR)
constraints:
  S:
    not:
      regex: ^""$
