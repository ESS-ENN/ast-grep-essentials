id: jwt-scala-hardcode-scala
language: scala
severity: warning
message: >-
  Hardcoded JWT secret or private key is used. This is a Insufficiently
  Protected Credentials weakness:
  https://cwe.mitre.org/data/definitions/522.html Consider using an
  appropriate security mechanism to protect the credentials (e.g. keeping
  secrets in environment variables).
note: >-
  [CWE-522] Insufficiently Protected Credentials.
  [REFERENCES]
      - https://jwt-scala.github.io/jwt-scala/
utils:
  $.decodeJson():
    kind: call_expression
    all:
      - has:
          stopBy: neighbor
          kind: field_expression
          all:
            - has:
                stopBy: neighbor
                kind: identifier
                regex: '^Jwt|JwtArgonaut|JwtCirce|JwtJson4s|JwtJson|JwtUpickle$'
            - has:
                stopBy: neighbor
                kind: identifier
                nthChild: 2
                regex: '^encode|decode|decodeRawAll|decodeRaw|decodeAll|validate|isValid|decodeJson|decodeJsonAll$'
      - has:
          stopBy: neighbor
          kind: arguments
          any:
            - has:
                stopBy: neighbor
                kind: string
                nthChild: 2
                pattern: $S
            - has:
                stopBy: neighbor
                kind: string
                nthChild: 2
                pattern: $S
      - inside:
          stopBy: end
          kind: compilation_unit
          has:
            stopBy: end
            kind: import_declaration
            pattern: import pdi.jwt.$DEPS
  $.decodeJson()_with_instance:
    kind: call_expression
    all:
      - has:
          stopBy: neighbor
          kind: field_expression
          all:
            - has:
                stopBy: neighbor
                kind: identifier
                regex: '^Jwt|JwtArgonaut|JwtCirce|JwtJson4s|JwtJson|JwtUpickle$'
            - has:
                stopBy: neighbor
                kind: identifier
                nthChild: 2
                regex: '^encode|decode|decodeRawAll|decodeRaw|decodeAll|validate|isValid|decodeJson|decodeJsonAll$'
      - has:
          stopBy: neighbor
          kind: arguments
          any:
            - has:
                stopBy: end
                kind: identifier
                nthChild: 2
                pattern: $V
            - has:
                stopBy: end
                kind: identifier
                nthChild: 2
                pattern: $V
      - inside:
          stopBy: end
          any:
          - kind: object_definition
            has:
             stopBy: end
             kind: val_definition
             all:
              - has:
                  stopBy: end
                  kind: identifier
                  pattern: $V
              - has:
                  stopBy: end
                  kind: string
                  pattern: $S
          - kind: class_definition
            has:
             stopBy: end
             kind: val_definition
             all:
              - has:
                  stopBy: end
                  kind: identifier
                  pattern: $V
              - has:
                  stopBy: neighbor
                  kind: string
                  pattern: $S
      - inside:
          stopBy: end
          kind: compilation_unit
          has:
            stopBy: end
            kind: import_declaration
            pattern: import pdi.jwt.$DEPS
rule:
  kind: call_expression
  any: 
    - matches: $.decodeJson()
    - matches: $.decodeJson()_with_instance
constraints:
  S:
    not:
      regex: ^""$
