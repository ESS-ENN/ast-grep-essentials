id: python-requests-oauth-hardcoded-secret-python
language: python
severity: warning
message: >-
  A secret is hard-coded in the application. Secrets stored in source
  code, such as credentials, identifiers, and other types of sensitive data,
  can be leaked and used by internal or external malicious actors. Use
  environment variables to securely provide credentials and other secrets or
  retrieve them from a secure vault or Hardware Security Module (HSM).
note: >-
  [CWE-798]: Use of Hard-coded Credentials
  [OWASP A07:2021]: Identification and Authentication Failures
  [REFERENCES]
       https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
utils:
  match_call:
    kind: call
    all:
      - has:
          stopBy: end
          kind: identifier
          field: function
          pattern: $OAUTH
      - has:
          kind: argument_list
          field: arguments
          all:
            - has:
                kind: string
            - has:
                kind: string
            - has:
                kind: string
            - has:
                kind: string
    inside:
      stopBy: end
      kind: assignment
      has:
        stopBy: end
        kind: identifier
      inside:
        stopBy: end
        kind: expression_statement
        follows:
          stopBy: end
          kind: import_from_statement
          all:
            - has:
                kind: dotted_name
                field: module_name
                has:
                  kind: identifier
                  regex: "^requests_oauthlib$"
            - has:
                kind: dotted_name
                field: name
                has:
                  kind: identifier
                  pattern: $OAUTH
  match_call_with_authorization:
    kind: call
    all:
      - has:
          stopBy: end
          kind: attribute
          field: function
          all:
            - has:
                stopBy: end
                kind: identifier
                field: object
            - has:
                stopBy: end
                kind: identifier
                regex: "^fetch_token$"
                field: attribute
      - has:
          stopBy: end
          kind: argument_list
          field: arguments
          all:
            - has:
                stopBy: end
                kind: string
            - has:
                stopBy: end
                kind: keyword_argument
                all:
                  - has:
                      stopBy: end
                      kind: identifier
                      field: name
                  - has:
                      stopBy: end
                      kind: identifier
                      field: value
            - has:
                stopBy: end
                kind: keyword_argument
                all:
                  - has:
                      stopBy: end
                      kind: identifier
                      field: name
                      regex: "^client_secret$"
                  - has:
                      stopBy: end
                      kind: identifier
                      field: value
                      pattern: $CLIENT_SECRET
    inside:
      stopBy: end
      kind: assignment
      has:
        stopBy: end
        kind: identifier
      inside:
        stopBy: end
        kind: expression_statement
        follows:
          stopBy: end
          kind: expression_statement
          has:
            stopBy: end
            kind: assignment
            all:
              - has:
                  stopBy: end
                  kind: identifier
                  pattern: $CLIENT_SECRET
              - has:
                  kind: string
                  all:
                    - has:
                        kind: string_start
                    - has:
                        kind: string_content
                    - has:
                        kind: string_end
          follows:
            stopBy: end
            kind: import_from_statement
            all:
              - has:
                  kind: dotted_name
                  field: module_name
                  regex: "^requests_oauthlib$"
              - has:
                  kind: dotted_name
                  field: name
              - has:
                  kind: dotted_name
                  field: name
  match_call_with_authorization_response:
    kind: call
    all:
      - has:
          stopBy: end
          kind: attribute
          field: function
          all:
            - has:
                stopBy: end
                kind: identifier
                field: object
                pattern: $OAUTHH
            - has:
                stopBy: end
                kind: identifier
                field: attribute
                regex: "^fetch_token$"
      - has:
          stopBy: end
          kind: argument_list
          field: arguments
          all:
            - has:
                kind: string
            - has:
                kind: keyword_argument
            - has:
                kind: keyword_argument
                all:
                  - has:
                      kind: identifier
                      field: name
                      regex: "^client_secret$"
                  - has:
                      kind: string
    inside:
      stopBy: end
      kind: assignment
      has:
        stopBy: end
        kind: identifier
      inside:
        stopBy: end
        kind: expression_statement
        follows:
          stopBy: end
          kind: expression_statement
          has:
            stopBy: end
            kind: assignment
            all:
              - has:
                  stopBy: end
                  kind: identifier
                  pattern: $OAUTHH
              - has:
                  stopBy: end
                  kind: call
          follows:
            stopBy: end
            kind: import_from_statement
            all:
              - has:
                  kind: dotted_name
                  field: module_name
                  has:
                    kind: identifier
                    regex: "^requests_oauthlib$"
              - has:
                  kind: dotted_name
                  field: name
              - has:
                  kind: dotted_name
                  field: name
  match_call_with_return:
    kind: call
    all:
      - has:
          stopBy: end
          kind: attribute
          all:
            - has:
                stopBy: end
                kind: identifier
                field: object
                pattern: $O
            - has:
                stopBy: end
                kind: identifier
                field: attribute
                regex: "^fetch_token$"
      - has:
          stopBy: end
          kind: argument_list
          all:
            - has:
                kind: string
            - has:
                kind: keyword_argument
            - has:
                kind: keyword_argument
                all:
                  - has:
                      kind: identifier
                      field: name
                      regex: "^client_secret$"
                  - has:
                      kind: string
    inside:
      stopBy: end
      kind: return_statement
      follows:
        stopBy: end
        kind: expression_statement
        has:
          kind: assignment
          all:
            - has:
                kind: identifier
                pattern: $O
            - has:
                kind: call
        inside:
          stopBy: end
          kind: function_definition
          follows:
            stopBy: end
            kind: import_from_statement
            all:
              - has:
                  kind: dotted_name
                  field: module_name
                  has:
                    kind: identifier
                    regex: "^requests_oauthlib$"
              - has:
                  kind: dotted_name
                  field: name
                  has:
                    kind: identifier
              - has:
                  kind: dotted_name
                  field: name
  match_call_without_return_not_follow:
    kind: call
    all:
      - has:
          kind: identifier
          pattern: $IMP
      - has:
          kind: argument_list
          field: arguments
          all:
            - has:
                kind: string
            - has:
                kind: string
            - has:
                kind: string
            - has:
                kind: string
    inside:
      stopBy: end
      kind: return_statement
      inside:
        stopBy: end
        kind: function_definition
        follows:
          stopBy: end
          kind: import_from_statement
          all:
            - has:
                kind: dotted_name
                field: module_name
                has:
                  kind: identifier
                  regex: "^requests_oauthlib$"
            - has:
                kind: dotted_name
                field: name
                has:
                  kind: identifier
                  pattern: $IMP
            - has:
                kind: dotted_name
                field: name
rule:
  any:
    - matches: match_call
    - matches: match_call_with_authorization
    - matches: match_call_with_authorization_response
    - matches: match_call_with_return
    - matches: match_call_without_return_not_follow
