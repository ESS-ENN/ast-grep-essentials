id: python-requests-empty-password-python
severity: warning
language: python
message: >-
      The application creates a database connection with an empty password.
      This can lead to unauthorized access by either an internal or external
      malicious actor. To prevent this vulnerability, enforce authentication
      when connecting to a database by using environment variables to securely
      provide credentials or retrieving them from a secure vault or HSM
      (Hardware Security Module).
note: >-
  [CWE-287] Improper Authentication.
  [REFERENCES]
      - https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
utils:
  requests.auth.HTTPBasicAuth($USER,"",...):
    kind: call
    all:
      - has:
          stopBy: neighbor
          kind: attribute
          regex: ^requests.auth.HTTPBasicAuth|requests.auth.HTTPDigestAuth|requests.auth.HTTPProxyAuth$
      - has:
          stopBy: neighbor
          kind: argument_list
          all:
            - has:
                stopBy: neighbor
                pattern: $$$
                nthChild: 1
            - has:
                stopBy: neighbor
                kind: string
                nthChild: 2
                not:
                  has:
                    stopBy: end
                    kind: string_content
  HTTPBasicAuth($USER,"",...):
    kind: call
    all:
      - has:
          stopBy: neighbor
          kind: identifier
          regex: ^HTTPBasicAuth$
      - has:
          stopBy: neighbor
          kind: argument_list
          all:
            - has:
                stopBy: neighbor
                kind: string
                nthChild: 1
                has:
                  stopBy: end
                  kind: string_content
            - has:
                stopBy: neighbor
                kind: string
                nthChild: 2
                not:
                  has:
                   stopBy: end
                   kind: string_content
      - inside:
          stopBy: end
          kind: module
          has:
            stopBy: end
            kind: import_from_statement
            pattern: from requests.auth import HTTPBasicAuth
  HTTPDigestAuth($USER,"",...):
    kind: call
    all:
      - has:
          stopBy: neighbor
          kind: identifier
          regex: ^HTTPDigestAuth$ 
      - has:
          stopBy: neighbor
          kind: argument_list
          all:
            - has:
                stopBy: neighbor
                kind: string
                nthChild: 1
                has:
                  stopBy: end
                  kind: string_content
            - has:
                stopBy: neighbor
                kind: string
                nthChild: 2
                not:
                  has:
                   stopBy: end
                   kind: string_content
      - inside:
          stopBy: end
          kind: module
          has:
            stopBy: end
            kind: import_from_statement
            pattern: from requests.auth import HTTPDigestAuth     
  HTTPProxyAuth($USER,"",...):
    kind: call
    all:
      - has:
          stopBy: neighbor
          kind: identifier
          regex: ^HTTPProxyAuth$ 
      - has:
          stopBy: neighbor
          kind: argument_list
          all:
            - has:
                stopBy: neighbor
                kind: string
                nthChild: 1
                has:
                  stopBy: end
                  kind: string_content
            - has:
                stopBy: neighbor
                kind: string
                nthChild: 2
                not:
                  has:
                   stopBy: end
                   kind: string_content
      - inside:
          stopBy: end
          kind: module
          has:
            stopBy: end
            kind: import_from_statement
            pattern: from requests.auth import HTTPProxyAuth 
  requests.auth.HTTPBasicAuth($USER,"",...)with_instance:
    kind: call
    all:
      - has:
          stopBy: neighbor
          kind: attribute
          regex: ^requests.auth.HTTPBasicAuth|requests.auth.HTTPDigestAuth|requests.auth.HTTPProxyAuth$
      - has:
          stopBy: neighbor
          kind: argument_list
          all:
            - has:
                stopBy: neighbor
                pattern: $$$
                nthChild: 1
            - has:
                stopBy: neighbor
                kind: identifier
                pattern: $H
      - inside:
          stopBy: end
          kind: expression_statement
          follows:
            stopBy: end
            kind: expression_statement
            has:
              stopBy: neighbor
              kind: assignment
              all:
                - has:
                    stopBy: neighbor
                    kind: identifier
                    pattern: $H
                - has:
                    stopBy: neighbor
                    kind: string
                    not:
                      has:
                        stopBy: end
                        kind: string_content
  HTTPBasicAuth($USER,"",...)with_instance:
    kind: call
    all:
      - has:
          stopBy: neighbor
          kind: identifier
          regex: ^HTTPBasicAuth$
      - has:
          stopBy: neighbor
          kind: argument_list
          all:
            - has:
                stopBy: neighbor
                kind: string
                nthChild: 1
                has:
                  stopBy: end
                  kind: string_content
            - has:
                stopBy: neighbor
                kind: identifier
                pattern: $H
      - inside:
          stopBy: end
          kind: module
          has:
            stopBy: end
            kind: import_from_statement
            pattern: from requests.auth import HTTPBasicAuth
      - inside:
          stopBy: end
          kind: expression_statement
          follows:
            stopBy: end
            kind: expression_statement
            has:
              stopBy: neighbor
              kind: assignment
              all:
                - has:
                    stopBy: neighbor
                    kind: identifier
                    pattern: $H
                - has:
                    stopBy: neighbor
                    kind: string
                    not:
                      has:
                        stopBy: end
                        kind: string_content
  HTTPDigestAuth($USER,"",...)with_instance:
    kind: call
    all:
      - has:
          stopBy: neighbor
          kind: identifier
          regex: ^HTTPDigestAuth$
      - has:
          stopBy: neighbor
          kind: argument_list
          all:
            - has:
                stopBy: neighbor
                kind: string
                nthChild: 1
                has:
                  stopBy: end
                  kind: string_content
            - has:
                stopBy: neighbor
                kind: identifier
                pattern: $H
      - inside:
          stopBy: end
          kind: module
          has:
            stopBy: end
            kind: import_from_statement
            pattern: from requests.auth import HTTPDigestAuth
      - inside:
          stopBy: end
          kind: expression_statement
          follows:
            stopBy: end
            kind: expression_statement
            has:
              stopBy: neighbor
              kind: assignment
              all:
                - has:
                    stopBy: neighbor
                    kind: identifier
                    pattern: $H
                - has:
                    stopBy: neighbor
                    kind: string
                    not:
                      has:
                        stopBy: end
                        kind: string_content
  HTTPProxyAuth($USER,"",...)with_instance:
    kind: call
    all:
      - has:
          stopBy: neighbor
          kind: identifier
          regex: ^HTTPProxyAuth$
      - has:
          stopBy: neighbor
          kind: argument_list
          all:
            - has:
                stopBy: neighbor
                kind: string
                nthChild: 1
                has:
                  stopBy: end
                  kind: string_content
            - has:
                stopBy: neighbor
                kind: identifier
                pattern: $H
      - inside:
          stopBy: end
          kind: module
          has:
            stopBy: end
            kind: import_from_statement
            pattern: from requests.auth import HTTPProxyAuth
      - inside:
          stopBy: end
          kind: expression_statement
          follows:
            stopBy: end
            kind: expression_statement
            has:
              stopBy: neighbor
              kind: assignment
              all:
                - has:
                    stopBy: neighbor
                    kind: identifier
                    pattern: $H
                - has:
                    stopBy: neighbor
                    kind: string
                    not:
                      has:
                        stopBy: end
                        kind: string_content
rule:
  kind: call  
  any:
    - matches: requests.auth.HTTPBasicAuth($USER,"",...)
    - matches: HTTPBasicAuth($USER,"",...)
    - matches: HTTPDigestAuth($USER,"",...)
    - matches: HTTPProxyAuth($USER,"",...)
    - matches: requests.auth.HTTPBasicAuth($USER,"",...)with_instance
    - matches: HTTPBasicAuth($USER,"",...)with_instance
    - matches: HTTPDigestAuth($USER,"",...)with_instance
    - matches: HTTPProxyAuth($USER,"",...)with_instance
