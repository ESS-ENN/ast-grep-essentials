id: python-pymongo-empty-password-python
language: python
severity: warning
message: >-
  The application creates a database connection with an empty password.
  This can lead to unauthorized access by either an internal or external
  malicious actor. To prevent this vulnerability, enforce authentication
  when connecting to a database by using environment variables to securely
  provide credentials or retrieving them from a secure vault or HSM
  (Hardware Security Module).
note: >-
  [CWE-287]: Improper Authentication
  [OWASP A07:2021]: Identification and Authentication Failures
  [REFERENCES]
       https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
utils:
  match_call:
    kind: expression_statement
    all:
      - has:
          kind: call
          all:
            - has:
                kind: identifier
                field: function
                regex: "^MongoClient$"
            - has:
                kind: argument_list
                all:
                  - has:
                      kind: keyword_argument
                      has:
                        kind: identifier
                        all:
                          - not:
                              precedes:
                                stopBy: end
                                kind: subscript
                          - not:
                              precedes:
                                stopBy: end
                                kind: call
                  - has:
                      stopBy: end
                      kind: string
    follows:
      stopBy: end
      kind: import_from_statement
      all:
        - has:
            stopBy: end
            kind: dotted_name
            field: module_name
            has:
              stopBy: end
              kind: identifier
              regex: "^pymongo$"
        - has:
            stopBy: end
            kind: dotted_name
            field: name
            has:
              stopBy: end
              kind: identifier
              regex: "^MongoClient$"
  match_call_with_string:
    kind: expression_statement
    all:
      - has:
          kind: call
          all:
            - has:
                kind: identifier
                field: function
                regex: "^MongoClient$"
            - has:
                kind: argument_list
                has:
                  stopBy: end
                  kind: keyword_argument
                  all:
                    - has:
                        stopBy: end
                        kind: identifier
                        field: name
                        regex: "^password$"
                    - has:
                        stopBy: end
                        kind: identifier
                        field: value
                        pattern: $T
      - follows:
          stopBy: end
          kind: expression_statement
          all:
            - has:
                stopBy: end
                kind: assignment
                has:
                  stopBy: end
                  kind: identifier
                  pattern: $T
            - has:
                stopBy: end
                kind: string
                all:
                  - has:
                      stopBy: end
                      kind: string_start
                  - has:
                      stopBy: end
                      kind: string_end
          follows:
            stopBy: end
            kind: import_from_statement
            all:
              - has:
                  stopBy: end
                  kind: dotted_name
                  field: module_name
                  has:
                    stopBy: end
                    kind: identifier
                    regex: "^pymongo$"
              - has:
                  stopBy: end
                  kind: dotted_name
                  field: name
                  has:
                    stopBy: end
                    kind: identifier
                    regex: "^MongoClient$"
rule:
  any:
    - matches: match_call
    - matches: match_call_with_string
