id: python-tormysql-empty-password-python
language: python
severity: warning
message: >-
  The application creates a database connection with an empty password.
  This can lead to unauthorized access by either an internal or external
  malicious actor. To prevent this vulnerability, enforce authentication
  when connecting to a database by using environment variables to securely
  provide credentials or retrieving them from a secure vault or HSM
  (Hardware Security Module).
note: >-
  [CWE-287]: Improper Authentication
  [OWASP A07:2021]: Identification and Authentication Failures
  [REFERENCES]
       https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
utils:
  match_expression_statement:
    kind: expression_statement
    has:
      stopBy: end
      kind: call
      all:
        - has:
            stopBy: end
            kind: attribute
            field: function
            all:
              - has:
                  stopBy: end
                  kind: identifier
                  field: object
                  regex: "^tormysql$"
              - has:
                  stopBy: end
                  kind: identifier
                  field: attribute
                  regex: "^ConnectionPool$"
        - has:
            stopBy: end
            kind: argument_list
            field: arguments
            has:
              stopBy: end
              kind: keyword_argument
              all:
                - has:
                    stopBy: end
                    kind: identifier
                    field: name
                    regex: "^password$"
                - has:
                    kind: string
                    field: value
                    all:
                      - has:
                          kind: string_start
                          not:
                            precedes:
                              stopBy: end
                              kind: string_content
                      - has:
                          kind: string_end

  match_expression_statement_with_identifier:
    kind: expression_statement
    has:
      stopBy: end
      kind: call
      all:
        - has:
            stopBy: end
            kind: attribute
            field: function
            all:
              - has:
                  stopBy: end
                  kind: identifier
                  field: object
                  regex: "^tormysql$"
              - has:
                  stopBy: end
                  kind: identifier
                  field: attribute
                  regex: "^ConnectionPool$"
        - has:
            stopBy: end
            kind: argument_list
            field: arguments
            has:
              stopBy: end
              kind: keyword_argument
              all:
                - has:
                    kind: identifier
                    field: name
                    regex: "^password$"
                - has:
                    kind: identifier
                    field: value
                    pattern: $PASS
    follows:
      stopBy: end
      kind: expression_statement
      has:
        stopBy: end
        kind: assignment
        all:
          - has:
              stopBy: end
              kind: identifier
              pattern: $PASS
          - has:
              stopBy: end
              kind: string
  match_direct_expression_with_passwd:
    kind: call
    all:
      - has:
          kind: attribute
          field: function
          all:
            - has:
                kind: identifier
                field: object
                regex: "^tormysql$"
            - has:
                kind: identifier
                field: attribute
                regex: "^ConnectionPool$"
      - has:
          kind: argument_list
          field: arguments
          has:
            kind: keyword_argument
            all:
              - has:
                  kind: identifier
                  field: name
                  regex: ^(passwd|password)$
              - has:
                  kind: string
                  field: value
                  all:
                    - has:
                        kind: string_start
                    - has:
                        kind: string_end
    inside:
      stopBy: end
      kind: return_statement
      inside:
        stopBy: end
        kind: function_definition
        has:
          kind: identifier
          field: name
  match_direct_expression_with_passwd_without_return:
    kind: call
    all:
      - has:
          stopBy: end
          kind: attribute
          field: function
          all:
            - has:
                stopBy: end
                kind: identifier
                field: object
                regex: "^tormysql$"
            - has:
                stopBy: end
                kind: identifier
                field: attribute
                regex: "^ConnectionPool$"
      - has:
          stopBy: end
          kind: argument_list
          field: arguments
          has:
            stopBy: end
            kind: keyword_argument
            all:
              - has:
                  kind: identifier
                  field: name
                  regex: ^(passwd)$
              - has:
                  kind: string
                  all:
                    - has:
                        kind: string_start
                    - has:
                        kind: string_end
    inside:
      stopBy: end
      kind: assignment
      inside:
        stopBy: end
        kind: expression_statement

rule:
  any:
    - matches: match_expression_statement
    - matches: match_expression_statement_with_identifier
    - matches: match_direct_expression_with_passwd
    - matches: match_direct_expression_with_passwd_without_return
