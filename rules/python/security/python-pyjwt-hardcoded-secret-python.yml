id: python-pyjwt-hardcoded-secret-python
language: python
severity: warning
message: >-
  A secret is hard-coded in the application. Secrets stored in source
  code, such as credentials, identifiers, and other types of sensitive data,
  can be leaked and used by internal or external malicious actors. Use
  environment variables to securely provide credentials and other secrets or
  retrieve them from a secure vault or Hardware Security Module (HSM).
note: >-
  [CWE-798]: Use of Hard-coded Credentials
  [OWASP A01:2021]: Identification and Authentication Failures
  [REFERENCES]
       https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
utils:
  match_call:
    kind: call
    all:
      - has:
          stopBy: end
          kind: attribute
          field: function
          all:
            - has:
                stopBy: end
                kind: identifier
                field: object
                regex: "^jwt$"
            - has:
                stopBy: end
                kind: identifier
                field: attribute
                regex: ^(encode|decode)$
      - has:
          stopBy: end
          kind: argument_list
          field: arguments
          all:
            - has:
                stopBy: end
                kind: dictionary
                has:
                  stopBy: end
                  kind: pair
                  all:
                    - has:
                        stopBy: end
                        kind: string
                        field: key
                    - has:
                        stopBy: end
                        kind: string
                        field: value
            - has:
                stopBy: end
                kind: identifier
                pattern: $R
            - has:
                stopBy: end
                kind: keyword_argument
                all:
                  - has:
                      stopBy: end
                      kind: identifier
                      field: name
                  - has:
                      stopBy: end
                      kind: string
                      field: value
                      all:
                        - has:
                            stopBy: end
                            kind: string_start
                        - has:
                            stopBy: end
                            kind: string_content
                        - has:
                            stopBy: end
                            kind: string_end
    inside:
      stopBy: end
      kind: expression_statement
      follows:
        stopBy: end
        kind: expression_statement
        all:
          - has:
              stopBy: end
              kind: assignment
              has:
                stopBy: end
                kind: identifier
                pattern: $R
          - has:
              stopBy: end
              kind: string
              all:
                - has:
                    stopBy: end
                    kind: string_start
                - has:
                    stopBy: end
                    kind: string_content
                - has:
                    stopBy: end
                    kind: string_end
  match_call_with_string:
    kind: call
    all:
      - has:
          stopBy: end
          kind: attribute
          field: function
          all:
            - has:
                stopBy: end
                kind: identifier
                field: object
                regex: "^jwt$"
            - has:
                stopBy: end
                kind: identifier
                field: attribute
                regex: ^(encode|decode)$
      - has:
          stopBy: end
          kind: argument_list
          field: arguments
          all:
            - has:
                stopBy: end
                kind: dictionary
                has:
                  stopBy: end
                  kind: pair
                  all:
                    - has:
                        stopBy: end
                        kind: string
                        field: key
                    - has:
                        stopBy: end
                        kind: string
                        field: value
            - has:
                kind: string
                all:
                  - has:
                      stopBy: end
                      kind: string_start
                  - has:
                      stopBy: end
                      kind: string_content
                  - has:
                      stopBy: end
                      kind: string_end
            - has:
                stopBy: end
                kind: keyword_argument
                all:
                  - has:
                      stopBy: end
                      kind: identifier
                      field: name
                  - has:
                      stopBy: end
                      kind: string
                      field: value
                      all:
                        - has:
                            stopBy: end
                            kind: string_start
                        - has:
                            stopBy: end
                            kind: string_content
                        - has:
                            stopBy: end
                            kind: string_end
    inside:
      stopBy: end
      kind: expression_statement
      follows:
        stopBy: end
        kind: expression_statement
        all:
          - has:
              stopBy: end
              kind: assignment
              has:
                stopBy: end
                kind: identifier
          - has:
              stopBy: end
              kind: string
              all:
                - has:
                    stopBy: end
                    kind: string_start
                - has:
                    stopBy: end
                    kind: string_content
                - has:
                    stopBy: end
                    kind: string_end
  match_from_imports:
    kind: call
    all:
      - has:
          stopBy: end
          kind: attribute
          field: function
          all:
            - has:
                stopBy: end
                kind: identifier
                field: object
                pattern: $T
            - has:
                stopBy: end
                kind: identifier
                field: attribute
                regex: ^(encode|decode)$
      - has:
          stopBy: end
          kind: argument_list
          field: arguments
          all:
            - has:
                stopBy: end
                kind: dictionary
                has:
                  stopBy: end
                  kind: pair
                  all:
                    - has:
                        stopBy: end
                        kind: string
                        field: key
                    - has:
                        stopBy: end
                        kind: string
                        field: value
            - has:
                stopBy: end
                kind: string
                all:
                  - has:
                      stopBy: end
                      kind: string_start
                  - has:
                      stopBy: end
                      kind: string_content
                  - has:
                      stopBy: end
                      kind: string_end
            - has:
                stopBy: end
                kind: keyword_argument
                all:
                  - has:
                      stopBy: end
                      kind: identifier
                      field: name
                  - has:
                      stopBy: end
                      kind: string
                      field: value
                      all:
                        - has:
                            stopBy: end
                            kind: string_start
                        - has:
                            stopBy: end
                            kind: string_content
                        - has:
                            stopBy: end
                            kind: string_end
    inside:
      stopBy: end
      kind: expression_statement
      follows:
        stopBy: end
        kind: import_statement
        has:
          stopBy: end
          kind: aliased_import
          field: name
          all:
            - has:
                stopBy: end
                kind: dotted_name
                field: name
                has:
                  stopBy: end
                  kind: identifier
                  regex: "^jwt$"
            - has:
                stopBy: end
                kind: identifier
                field: alias
                pattern: $T
  match_without_follow_import:
    kind: call
    all:
      - has:
          stopBy: end
          kind: attribute
          field: function
          all:
            - has:
                stopBy: end
                kind: identifier
                field: object
                regex: "^jwt$"
            - has:
                stopBy: end
                kind: identifier
                field: attribute
                regex: ^(encode|decode)$
      - has:
          stopBy: end
          kind: argument_list
          field: arguments
          all:
            - has:
                stopBy: end
                kind: dictionary
                has:
                  stopBy: end
                  kind: pair
                  all:
                    - has:
                        stopBy: end
                        kind: string
                        field: key
                    - has:
                        stopBy: end
                        kind: string
                        field: value
            - has:
                kind: string
                all:
                  - has:
                      stopBy: end
                      kind: string_start
                  - has:
                      stopBy: end
                      kind: string_content
                  - has:
                      stopBy: end
                      kind: string_end
            - has:
                stopBy: end
                kind: keyword_argument
                all:
                  - has:
                      stopBy: end
                      kind: identifier
                      field: name
                  - has:
                      stopBy: end
                      kind: string
                      field: value
                      all:
                        - has:
                            stopBy: end
                            kind: string_start
                        - has:
                            stopBy: end
                            kind: string_content
                        - has:
                            stopBy: end
                            kind: string_end
    inside:
      stopBy: end
      kind: expression_statement

  match_without_follow_import_string:
    kind: call
    all:
      - has:
          stopBy: end
          kind: attribute
          field: function
          all:
            - has:
                stopBy: end
                kind: identifier
                field: object
                regex: "^jwt$"
            - has:
                stopBy: end
                kind: identifier
                field: attribute
                regex: ^(encode|decode)$
      - has:
          stopBy: end
          kind: argument_list
          field: arguments
          all:
            - has:
                stopBy: end
                kind: string
            - has:
                stopBy: end
                kind: string
            - has:
                stopBy: end
                kind: keyword_argument
                all:
                  - has:
                      stopBy: end
                      kind: identifier
                      field: name
                  - has:
                      stopBy: end
                      kind: list
                      field: value
                      has:
                        stopBy: end
                        kind: string
                        all:
                          - has:
                              stopBy: end
                              kind: string_start
                          - has:
                              stopBy: end
                              kind: string_content
                          - has:
                              stopBy: end
                              kind: string_end
    inside:
      stopBy: end
      kind: expression_statement
rule:
  any:
    - matches: match_call
    - matches: match_call_with_string
    - matches: match_from_imports
    - matches: match_without_follow_import
    - matches: match_without_follow_import_string
