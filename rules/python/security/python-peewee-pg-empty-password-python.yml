id: python-peewee-pg-empty-password-python
severity: warning
language: python
message: >-
      The application creates a database connection with an empty password.
      This can lead to unauthorized access by either an internal or external
      malicious actor. To prevent this vulnerability, enforce authentication
      when connecting to a database by using environment variables to securely
      provide credentials or retrieving them from a secure vault or HSM
      (Hardware Security Module).
note: >-
  [CWE-287] Improper Authentication.
  [REFERENCES]
      - https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
utils:
  $DB(..., password="...",...):
    # $DB(..., password="...",...)
    kind: call
    all:
    - has:
        stopBy: neighbor
        pattern: $DB
        regex: ^PostgresqlDatabase|peewee.PostgresqlDatabase|PostgresqlExtDatabase|playhouse.postgres_ext.PostgresqlExtDatabase|PooledPostgresqlDatabase|playhouse.pool.PooledPostgresqlDatabase|CockroachDatabase|playhouse.cockroachdb.CockroachDatabase|PooledCockroachDatabase|playhouse.cockroachdb.PooledCockroachDatabase$
    - has:
        stopBy: neighbor
        kind: argument_list
        has:
          stopBy: end
          kind: keyword_argument
          all:
            - has:
                stopBy: neighbor
                kind: identifier
                regex: ^password|passwd$
            - has:
                stopBy: neighbor
                kind: string
                not:
                  has:
                   stopBy: neighbor
                   kind: string_content
  $DB(..., password=$VAR,...):
    # $DB(..., password=$VAR,...)_with_instance
    kind: call
    all:
    - has:
        stopBy: neighbor
        pattern: $DB
        regex: ^PostgresqlDatabase|peewee.PostgresqlDatabase|PostgresqlExtDatabase|playhouse.postgres_ext.PostgresqlExtDatabase|PooledPostgresqlDatabase|playhouse.pool.PooledPostgresqlDatabase|CockroachDatabase|playhouse.cockroachdb.CockroachDatabase|PooledCockroachDatabase|playhouse.cockroachdb.PooledCockroachDatabase$
    - has:
        stopBy: neighbor
        kind: argument_list
        has:
          stopBy: end
          kind: keyword_argument
          all:
            - has:
                stopBy: neighbor
                kind: identifier
                regex: ^password|passwd$
            - has:
                stopBy: neighbor
                kind: identifier
                pattern: $R
                nthChild: 2
    - inside:
        stopBy: end
        kind: expression_statement
        follows: 
          stopBy: end
          kind: expression_statement
          has:
              stopBy: neighbor
              kind: assignment
              all:
                - has:
                    stopBy: neighbor
                    kind: identifier
                    pattern: $R
                - has:
                    stopBy: neighbor
                    kind: string
                    not:
                      has:
                       stopBy: neighbor
                       kind: string_content
  $X.init(..., password="...", ...):
    # $X.init(..., password="...", ...)
    kind: call
    all:
    - has:
        stopBy: neighbor
        kind: attribute
        all:
          - has:
              stopBy: neighbor
              pattern: $D
              nthChild: 1
          - has:
              stopBy: neighbor
              kind: identifier
              regex: ^init$
    - has:
        stopBy: neighbor
        kind: argument_list
        has:
          stopBy: end
          kind: keyword_argument
          all:
            - has:
                stopBy: neighbor
                kind: identifier
                regex: ^password|passwd$
            - has:
                stopBy: neighbor
                kind: string
                not:
                  has:
                   stopBy: neighbor
                   kind: string_content
    - inside:
        stopBy: end
        kind: expression_statement
        follows:
          stopBy: end
          kind: expression_statement
          has:
            stopBy: neighbor
            kind: assignment
            all:
              - has:
                  stopBy: neighbor
                  kind: identifier
                  pattern: $D
              - has:
                  stopBy: neighbor
                  regex: ^PostgresqlDatabase|peewee.PostgresqlDatabase|PostgresqlExtDatabase|playhouse.postgres_ext.PostgresqlExtDatabase|PooledPostgresqlDatabase|playhouse.pool.PooledPostgresqlDatabase|CockroachDatabase|playhouse.cockroachdb.CockroachDatabase|PooledCockroachDatabase|playhouse.cockroachdb.PooledCockroachDatabase$
  $X.init(..., password=$VAR, ...):
    # $X.init(..., password=$VAR, ...)
    kind: call
    all:
    - has:
        stopBy: neighbor
        kind: attribute
        all:
          - has:
              stopBy: neighbor
              pattern: $D
              nthChild: 1
          - has:
              stopBy: neighbor
              kind: identifier
              regex: ^init$
    - has:
        stopBy: neighbor
        kind: argument_list
        has:
          stopBy: end
          kind: keyword_argument
          all:
            - has:
                stopBy: neighbor
                kind: identifier
                regex: ^password|passwd$
            - has:
                stopBy: neighbor
                kind: identifier
                pattern: $PASS
                nthChild: 2
    - inside:
        stopBy: end
        kind: expression_statement
        follows:
          stopBy: end
          kind: expression_statement
          has:
            stopBy: neighbor
            kind: assignment
            all:
              - has:
                  stopBy: neighbor
                  kind: identifier
                  pattern: $D
              - has:
                  stopBy: neighbor
                  regex: ^PostgresqlDatabase|peewee.PostgresqlDatabase|PostgresqlExtDatabase|playhouse.postgres_ext.PostgresqlExtDatabase|PooledPostgresqlDatabase|playhouse.pool.PooledPostgresqlDatabase|CockroachDatabase|playhouse.cockroachdb.CockroachDatabase|PooledCockroachDatabase|playhouse.cockroachdb.PooledCockroachDatabase$
    - inside:
        stopBy: end
        kind: expression_statement
        follows: 
          stopBy: end
          kind: expression_statement
          has:
              stopBy: neighbor
              kind: assignment
              all:
                - has:
                    stopBy: neighbor
                    kind: identifier
                    pattern: $PASS
                - has:
                    stopBy: neighbor
                    kind: string
                    not:
                      has:
                       stopBy: neighbor
                       kind: string_content
rule:
  kind: call
  any:
    - matches: $DB(..., password="...",...)
    - matches: $DB(..., password=$VAR,...)
    - matches: $X.init(..., password="...", ...)
    - matches: $X.init(..., password=$VAR, ...)
