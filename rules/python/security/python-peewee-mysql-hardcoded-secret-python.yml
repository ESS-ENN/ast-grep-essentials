id: python-peewee-mysql-hardcoded-secret-python
severity: warning
language: python
message: >-
      A secret is hard-coded in the application. Secrets stored in source
      code, such as credentials, identifiers, and other types of sensitive data,
      can be leaked and used by internal or external malicious actors. Use
      environment variables to securely provide credentials and other secrets or
      retrieve them from a secure vault or Hardware Security Module (HSM).
note: >-
  [CWE-798] Use of Hard-coded Credentials.
  [REFERENCES]
      - https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
utils:
  $DB(..., password="...",...):
    # $DB(..., password="...",...)
    kind: call
    all:
    - has:
        stopBy: neighbor
        pattern: $DB
        regex: ^MySQLDatabase|peewee.MySQLDatabase|MySQLConnectorDatabase|playhouse.mysql_ext.MySQLConnectorDatabase|MariaDBConnectorDatabase|playhouse.mysql_ext.MariaDBConnectorDatabase|PooledMySQLDatabase|playhouse.pool.PooledMySQLDatabase$
    - has:
        stopBy: neighbor
        kind: argument_list
        has:
          stopBy: end
          kind: keyword_argument
          all:
            - has:
                stopBy: neighbor
                kind: identifier
                regex: ^password|passwd$
            - has:
                stopBy: neighbor
                kind: string
                has:
                  stopBy: neighbor
                  kind: string_content
  $DB(..., password=$VAR,...):
    # $DB(..., password=$VAR,...)_with_instance
    kind: call
    all:
    - has:
        stopBy: neighbor
        pattern: $DB
        regex: ^MySQLDatabase|peewee.MySQLDatabase|MySQLConnectorDatabase|playhouse.mysql_ext.MySQLConnectorDatabase|MariaDBConnectorDatabase|playhouse.mysql_ext.MariaDBConnectorDatabase|PooledMySQLDatabase|playhouse.pool.PooledMySQLDatabase$
    - has:
        stopBy: neighbor
        kind: argument_list
        has:
          stopBy: end
          kind: keyword_argument
          all:
            - has:
                stopBy: neighbor
                kind: identifier
                regex: ^password|passwd$
            - has:
                stopBy: neighbor
                kind: identifier
                pattern: $R
                nthChild: 2
    - inside:
        stopBy: end
        kind: expression_statement
        follows: 
          stopBy: end
          kind: expression_statement
          has:
              stopBy: neighbor
              kind: assignment
              all:
                - has:
                    stopBy: neighbor
                    kind: identifier
                    pattern: $R
                - has:
                    stopBy: neighbor
                    kind: string
                    has:
                      stopBy: neighbor
                      kind: string_content
  $X.init(..., password="...", ...):
    # $X.init(..., password="...", ...)
    kind: call
    all:
    - has:
        stopBy: neighbor
        kind: attribute
        all:
          - has:
              stopBy: neighbor
              pattern: $D
              nthChild: 1
          - has:
              stopBy: neighbor
              kind: identifier
              regex: ^init$
    - has:
        stopBy: neighbor
        kind: argument_list
        has:
          stopBy: end
          kind: keyword_argument
          all:
            - has:
                stopBy: neighbor
                kind: identifier
                regex: ^password|passwd$
            - has:
                stopBy: neighbor
                kind: string
                has:
                  stopBy: neighbor
                  kind: string_content
    - inside:
        stopBy: end
        kind: expression_statement
        follows:
          stopBy: end
          kind: expression_statement
          has:
            stopBy: neighbor
            kind: assignment
            all:
              - has:
                  stopBy: neighbor
                  kind: identifier
                  pattern: $D
              - has:
                  stopBy: neighbor
                  regex: ^MySQLDatabase|peewee.MySQLDatabase|MySQLConnectorDatabase|playhouse.mysql_ext.MySQLConnectorDatabase|MariaDBConnectorDatabase|playhouse.mysql_ext.MariaDBConnectorDatabase|PooledMySQLDatabase|playhouse.pool.PooledMySQLDatabase$
  $X.init(..., password=$VAR, ...):
    # $X.init(..., password=$VAR, ...)
    kind: call
    all:
    - has:
        stopBy: neighbor
        kind: attribute
        all:
          - has:
              stopBy: neighbor
              pattern: $D
              nthChild: 1
          - has:
              stopBy: neighbor
              kind: identifier
              regex: ^init$
    - has:
        stopBy: neighbor
        kind: argument_list
        has:
          stopBy: end
          kind: keyword_argument
          all:
            - has:
                stopBy: neighbor
                kind: identifier
                regex: ^password|passwd$
            - has:
                stopBy: neighbor
                kind: identifier
                pattern: $PASS
                nthChild: 2
    - inside:
        stopBy: end
        kind: expression_statement
        follows:
          stopBy: end
          kind: expression_statement
          has:
            stopBy: neighbor
            kind: assignment
            all:
              - has:
                  stopBy: neighbor
                  kind: identifier
                  pattern: $D
              - has:
                  stopBy: neighbor
                  regex: ^MySQLDatabase|peewee.MySQLDatabase|MySQLConnectorDatabase|playhouse.mysql_ext.MySQLConnectorDatabase|MariaDBConnectorDatabase|playhouse.mysql_ext.MariaDBConnectorDatabase|PooledMySQLDatabase|playhouse.pool.PooledMySQLDatabase$
    - inside:
        stopBy: end
        kind: expression_statement
        follows: 
          stopBy: end
          kind: expression_statement
          has:
              stopBy: neighbor
              kind: assignment
              all:
                - has:
                    stopBy: neighbor
                    kind: identifier
                    pattern: $PASS
                - has:
                    stopBy: neighbor
                    kind: string
                    has:
                      stopBy: neighbor
                      kind: string_content
rule:
  kind: call
  any:
    - matches: $DB(..., password="...",...)
    - matches: $DB(..., password=$VAR,...)
    - matches: $X.init(..., password="...", ...)
    - matches: $X.init(..., password=$VAR, ...)
