id: ruby-octokit-hardcoded-secret-ruby
language: ruby
severity: warning
message: >-
  A secret is hard-coded in the application. Secrets stored in source
  code, such as credentials, identifiers, and other types of sensitive data,
  can be leaked and used by internal or external malicious actors. Use
  environment variables to securely provide credentials and other secrets or
  retrieve them from a secure vault or Hardware Security Module (HSM).
note: >-
  [CWE-798] Use of Hard-coded Credentials.
  [REFERENCES]
      - https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
utils:
  Octokit::Client.new(password:""):
    # Octokit::Client.new(..., password: "", ...)
   kind: call
   all:
      - has:
          stopBy: neighbor
          kind: scope_resolution
          regex: ^Octokit::Client$
      - has:
          stopBy: neighbor
          regex: ^.$
      - has:
          stopBy: neighbor
          kind: identifier
          regex: ^new$
      - has:
          stopBy: neighbor
          kind: argument_list
          has:
            stopBy: end
            kind: pair
            all:
              - has:
                  stopBy: neighbor
                  regex: ^:password|:access_token|:client_secret|password|access_token|client_secret$
              - has:
                  stopBy: neighbor
                  kind: string
                  has:
                      stopBy: neighbor
                      kind: string_content
      - inside:
            stopBy: end
            kind: program
            has:
              stopBy: end
              kind: call
              pattern: require 'octokit'
  Octokit::Client.new(password:"")with_instance:
    # Octokit::Client.new(..., password: "", ...)
   kind: assignment
   all:
   - has:
      stopBy: end
      kind: call
      all:
      - has:
          stopBy: neighbor
          kind: scope_resolution
          regex: ^Octokit::Client$
      - has:
          stopBy: neighbor
          regex: ^.$
      - has:
          stopBy: neighbor
          kind: identifier
          regex: ^new$
      - has:
          stopBy: neighbor
          kind: argument_list
          has:
            stopBy: end
            kind: pair
            all:
              - has:
                  stopBy: neighbor
                  regex: ^:password|:access_token|:client_secret|password|access_token|client_secret$
              - has:
                  stopBy: neighbor
                  kind: identifier
                  nthChild: 2
                  pattern: $PASS
   - follows:
          stopBy: end
          kind: assignment
          pattern: $PASS = '$$$'
   - inside:
            stopBy: end
            kind: program
            has:
              stopBy: end
              kind: call
              pattern: require 'octokit'
rule:
 any:
     - kind: call
       matches: Octokit::Client.new(password:"")
     - kind: assignment
       matches: Octokit::Client.new(password:"")with_instance
