id: jwt-hardcoded-secret-csharp
severity: warning
language: csharp
message: >-
  A secret is hard-coded in the application. Secrets stored in source
  code, such as credentials, identifiers, and other types of sensitive data,
  can be leaked and used by internal or external malicious actors. It is
  recommended to rotate the secret and retrieve them from a secure secret
  vault or Hardware Security Module (HSM), alternatively environment
  variables can be used if allowed by your company policy.
note: >-
  [CWE-798] Use of Hard-coded Credentials.
  [REFERENCES]
      - https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures
utils:
  
    Jwt_IJwt_Decode_Directly:
        kind: invocation_expression
        all:
            - all:
               - has:
                  stopBy: neighbor
                  kind: member_access_expression
                  all:
                      - has:
                         stopBy: neighbor
                         kind: identifier
                         field: name
                         regex: (^Decode$)
                      - has:
                            stopBy: neighbor
                            kind: identifier
                            field: expression
                            pattern: $V
               - has:
                  stopBy: neighbor
                  kind: argument_list
                  any:
                         - has:
                            stopBy: neighbor
                            kind: argument
                            has:
                             stopBy: neighbor
                             kind: string_literal
                             has:
                                  stopBy: neighbor
                                  kind: string_literal_content
            - inside:
                stopBy: end
                kind: compilation_unit
                all:
                    - has:
                       stopBy: end
                       kind: declaration_list
                       has:
                         stopBy: end
                         kind: method_declaration
                         has:
                             stopBy: end
                             kind: local_declaration_statement
                             has:
                                stopBy: end
                                kind: variable_declaration
                                all:
                                - has:
                                    stopBy: neighbor
                                    kind: variable_declarator
                                    has:
                                        stopBy: end
                                        kind: identifier
                                        pattern: $V
                                - has:
                                    stopBy: neighbor
                                    kind: identifier
                                    regex: (^IJwtDecoder$|^JwtDecoder$)
                    - any:
                         - has:
                               stopBy: end
                               kind: using_directive
                               has:
                                stopBy: neighbor
                                kind: identifier
                                regex: '^JWT$'
                         - has:
                               stopBy: end
                               kind: using_directive
                               has:
                                   stopBy: neighbor
                                   kind: qualified_name
                                   all:
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^JWT$'
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^Builder$'

    Jwt_IJwt_Decode_with_Instance:
      kind: invocation_expression
      all:
            - all:
               - has:
                  stopBy: neighbor
                  kind: member_access_expression
                  all:
                      - has:
                         stopBy: neighbor
                         kind: identifier
                         field: name
                         regex: (^Decode$)
                      - has:
                            stopBy: neighbor
                            kind: identifier
                            pattern: $V
               - has:
                  stopBy: neighbor
                  kind: argument_list
                  all:
                         - has:
                            stopBy: neighbor
                            kind: argument
                         - has:
                               stopBy: neighbor
                               kind: argument
                               nthChild: 2
                               has:
                                   stopBy: neighbor
                                   kind: identifier
                                   pattern: $F
            - inside:
                stopBy: end
                kind: compilation_unit
                all:
                    - has:
                       stopBy: end
                       kind: declaration_list
                       has:
                         stopBy: end
                         kind: method_declaration
                         has:
                             stopBy: end
                             kind: local_declaration_statement
                             has:
                                stopBy: end
                                kind: variable_declaration
                                all:
                                - has:
                                    stopBy: neighbor
                                    kind: variable_declarator
                                    has:
                                        stopBy: end
                                        kind: identifier
                                        pattern: $V
                                - has:
                                    stopBy: neighbor
                                    kind: identifier
                                    regex: (^IJwtDecoder$|^JwtDecoder$)
                    - any:
                         - has:
                               stopBy: end
                               kind: using_directive
                               has:
                                stopBy: neighbor
                                kind: identifier
                                regex: '^JWT$'
                         - has:
                               stopBy: end
                               kind: using_directive
                               has:
                                   stopBy: neighbor
                                   kind: qualified_name
                                   all:
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^JWT$'
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^Builder$'
            - inside:
                  stopBy: end
                  kind: local_declaration_statement
                  follows:
                      stopBy: end
                      kind: local_declaration_statement
                      has:
                          stopBy: end
                          kind: variable_declarator
                          all:
                              - has:
                                    stopBy: neighbor
                                    kind: identifier
                                    pattern: $F
                              - has:
                                    stopBy: neighbor
                                    kind: string_literal
                                    has:
                                        stopBy: neighbor
                                        kind: string_literal_content

    JwtBuilder.Create()_Directly:
     kind: invocation_expression
     all:
         - has:
               stopBy: neighbor
               kind: member_access_expression
               all:
                   - has:
                         stopBy: neighbor
                         kind: invocation_expression
                         all:
                             - has:
                                   stopBy: end
                                   kind: member_access_expression
                                   all:
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^JwtBuilder$'
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^Create$'
                             - has:
                                   stopBy: neighbor
                                   kind: argument_list
                   - has:
                         stopBy: neighbor
                         kind: identifier
                         regex: '^WithSecret$'
         - has:
               stopBy: neighbor
               kind: argument_list
               has:
                   stopBy: neighbor
                   kind: argument
                   has:
                       stopBy: neighbor
                       kind: string_literal
                       has:
                           stopBy: neighbor
                           kind: string_literal_content
         - inside:
                stopBy: end
                kind: compilation_unit
                all:
                    - has:
                       stopBy: end
                       kind: declaration_list
                       has:
                         stopBy: end
                         kind: method_declaration
                         has:
                             stopBy: end
                             kind: local_declaration_statement
                             has:
                                stopBy: end
                                kind: variable_declaration
                                all:
                                - has:
                                    stopBy: neighbor
                                    kind: variable_declarator
                                    has:
                                        stopBy: end
                                        kind: identifier
                                        pattern: $V
                                - has:
                                    stopBy: neighbor
                                    kind: identifier
                                    regex: (^IJwtDecoder$|^JwtDecoder$)
                    - any:
                         - has:
                               stopBy: end
                               kind: using_directive
                               has:
                                stopBy: neighbor
                                kind: identifier
                                regex: '^JWT$'
                         - has:
                               stopBy: end
                               kind: using_directive
                               has:
                                   stopBy: neighbor
                                   kind: qualified_name
                                   all:
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^JWT$'
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^Builder$'

    JwtBuilder.Create()_Instance:
     kind: invocation_expression
     all:
         - has:
               stopBy: neighbor
               kind: member_access_expression
               all:
                   - has:
                         stopBy: neighbor
                         kind: invocation_expression
                         all:
                             - has:
                                   stopBy: end
                                   kind: member_access_expression
                                   all:
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^JwtBuilder$'
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^Create$'
                             - has:
                                   stopBy: neighbor
                                   kind: argument_list
                   - has:
                         stopBy: neighbor
                         kind: identifier
                         regex: '^WithSecret$'
         - has:
               stopBy: neighbor
               kind: argument_list
               has:
                   stopBy: neighbor
                   kind: argument
                   has:
                       stopBy: neighbor
                       kind: identifier
                       pattern: $Y
         - inside:
            stopBy: end
            kind: local_declaration_statement
            follows:
              stopBy: end
              kind: local_declaration_statement
              has:
                stopBy: end
                kind: variable_declarator
                all:
                  - has:
                     stopBy: neighbor
                     kind: identifier
                     pattern: $Y
                  - has:
                     stopBy: neighbor
                     kind: string_literal
                     has:
                      stopBy: neighbor
                      kind: string_literal_content
         - inside:
                stopBy: end
                kind: compilation_unit
                all:
                    - has:
                       stopBy: end
                       kind: declaration_list
                       has:
                         stopBy: end
                         kind: method_declaration
                         has:
                             stopBy: end
                             kind: local_declaration_statement
                             has:
                                stopBy: end
                                kind: variable_declaration
                                all:
                                - has:
                                    stopBy: neighbor
                                    kind: variable_declarator
                                    has:
                                        stopBy: end
                                        kind: identifier
                                        pattern: $V
                                - has:
                                    stopBy: neighbor
                                    kind: identifier
                                    regex: (^IJwtDecoder$|^JwtDecoder$)
                    - any:
                         - has:
                               stopBy: end
                               kind: using_directive
                               has:
                                stopBy: neighbor
                                kind: identifier
                                regex: '^JWT$'
                         - has:
                               stopBy: end
                               kind: using_directive
                               has:
                                   stopBy: neighbor
                                   kind: qualified_name
                                   all:
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^JWT$'
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^Builder$'

    JwtBuilder.Create()_builder.Instance:
     kind: expression_statement
     all:
      - has:
            stopBy: end
            kind: member_access_expression
            all:
                - has:
                      stopBy: neighbor
                      kind: identifier
                      pattern: $E
                - has:
                      stopBy: neighbor
                      kind: identifier
                      regex: '^WithSecret$'
      - has:
            stopBy: end
            kind: argument_list
            has:
             stopBy: neighbor
             kind: argument
             has:
                stopBy: neighbor
                kind: identifier
      - follows:
            stopBy: end
            kind: local_declaration_statement
            has:
                stopBy: end
                kind: variable_declarator
                all:
                 - has:
                       stopBy: neighbor
                       kind: identifier
                       pattern: $E
                 - has:
                       stopBy: neighbor
                       kind: invocation_expression
                       pattern: JwtBuilder.Create()
      - inside:
                stopBy: end
                kind: compilation_unit
                all:
                    - has:
                       stopBy: end
                       kind: declaration_list
                       has:
                         stopBy: end
                         kind: method_declaration
                         has:
                             stopBy: end
                             kind: local_declaration_statement
                             has:
                                stopBy: end
                                kind: variable_declaration
                                all:
                                - has:
                                    stopBy: neighbor
                                    kind: variable_declarator
                                    has:
                                        stopBy: end
                                        kind: identifier
                                        pattern: $V
                                - has:
                                    stopBy: neighbor
                                    kind: identifier
                                    regex: (^IJwtDecoder$|^JwtDecoder$)
                    - any:
                         - has:
                               stopBy: end
                               kind: using_directive
                               has:
                                stopBy: neighbor
                                kind: identifier
                                regex: '^JWT$'
                         - has:
                               stopBy: end
                               kind: using_directive
                               has:
                                   stopBy: neighbor
                                   kind: qualified_name
                                   all:
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^JWT$'
                                       - has:
                                             stopBy: neighbor
                                             kind: identifier
                                             regex: '^Builder$'

    Jwt_IJwt_Encode_Directly:
     kind: invocation_expression
     all:
         - inside:
               stopBy: end
               kind: method_declaration
               has:
                   stopBy: end
                   kind: local_declaration_statement
                   has:
                    stopBy: neighbor
                    kind: variable_declaration
                    all:
                     - has:
                           stopBy: neighbor
                           kind: identifier
                           regex: '^IJwtEncoder|JwtEncoder$'
                     - has:
                           stopBy: neighbor
                           kind: variable_declarator
                           all:
                               - has:
                                     stopBy: neighbor
                                     kind: identifier
                                     pattern: $V
                               - has:
                                     stopBy: neighbor
                                     kind: object_creation_expression
         - all:
               - has:
                  stopBy: neighbor
                  kind: member_access_expression
                  all:
                      - has:
                         stopBy: neighbor
                         kind: identifier
                         field: name
                         regex: (^Encode$)
                      - has:
                            stopBy: neighbor
                            kind: identifier
                            field: expression
                            pattern: $V
               - has:
                  stopBy: neighbor
                  kind: argument_list
                  any:
                         - has:
                            stopBy: neighbor
                            kind: argument
                            has:
                             stopBy: neighbor
                             kind: string_literal
                             has:
                                  stopBy: neighbor
                                  kind: string_literal_content
         - inside:
                 stopBy: end
                 kind: compilation_unit
                 any:
                    - has:
                            stopBy: end
                            kind: using_directive
                            has:
                                  stopBy: neighbor
                                  kind: qualified_name
                                  all:
                                        - has:
                                                stopBy: neighbor
                                                kind: identifier
                                                regex: '^JWT$'
                                        - has:
                                                stopBy: neighbor
                                                kind: identifier
                                                regex: '^Builder$'
                    - has:
                            stopBy: end
                            kind: using_directive
                            has:
                             stopBy: neighbor
                             kind: identifier
                             regex: '^JWT$'

    Jwt_IJwt_Encode_with_Instance:
      kind: invocation_expression
      all:
         - inside:
            stopBy: end
            kind: method_declaration
            all:
              - has:
                   stopBy: end
                   kind: local_declaration_statement
                   has:
                    stopBy: neighbor
                    kind: variable_declaration
                    all:
                     - has:
                           stopBy: neighbor
                           kind: identifier
                           regex: '^IJwtEncoder|JwtEncoder$'
                     - has:
                           stopBy: neighbor
                           kind: variable_declarator
                           all:
                               - has:
                                     stopBy: neighbor
                                     kind: identifier
                                     pattern: $V
                               - has:
                                     stopBy: neighbor
                                     kind: object_creation_expression
              - has:
                      stopBy: end
                      kind: variable_declarator
                      all:
                        - has:
                                stopBy: neighbor
                                kind: identifier
                                pattern: $F
                        - has:
                                stopBy: neighbor
                                kind: string_literal
                                has:
                                      stopBy: neighbor
                                      kind: string_literal_content
         - all:
               - has:
                  stopBy: neighbor
                  kind: member_access_expression
                  all:
                      - has:
                         stopBy: neighbor
                         kind: identifier
                         field: name
                         regex: (^Encode$)
                      - has:
                            stopBy: neighbor
                            kind: identifier
                            pattern: $V
               - has:
                  stopBy: neighbor
                  kind: argument_list
                  all:
                         - has:
                            stopBy: neighbor
                            kind: argument
                         - has:
                               stopBy: neighbor
                               kind: argument
                               nthChild: 2
                               has:
                                   stopBy: neighbor
                                   kind: identifier
                                   pattern: $F
         - inside:
                 stopBy: end
                 kind: compilation_unit
                 any:
                    - has:
                            stopBy: end
                            kind: using_directive
                            has:
                                  stopBy: neighbor
                                  kind: qualified_name
                                  all:
                                        - has:
                                                stopBy: neighbor
                                                kind: identifier
                                                regex: '^JWT$'
                                        - has:
                                                stopBy: neighbor
                                                kind: identifier
                                                regex: '^Builder$'
                    - has:
                            stopBy: end
                            kind: using_directive
                            has:
                             stopBy: neighbor
                             kind: identifier
                             regex: '^JWT$'
rule:
    any:
        - kind: invocation_expression
          any:
            - matches: Jwt_IJwt_Encode_Directly
            - matches: Jwt_IJwt_Decode_Directly
            - matches: Jwt_IJwt_Decode_with_Instance
            - matches: Jwt_IJwt_Encode_with_Instance
            - matches: JwtBuilder.Create()_Directly
            - matches: JwtBuilder.Create()_Instance
        - kind: expression_statement
          matches: JwtBuilder.Create()_builder.Instance
