id: scrypt-hardcoded-secret-swift
language: swift
severity: warning
message: >-
  A secret is hard-coded in the application. Secrets stored in source
  code, such as credentials, identifiers, and other types of sensitive data,
  can be leaked and used by internal or external malicious actors. Use
  environment variables to securely provide credentials and other secrets or
  retrieve them from a secure vault or Hardware Security Module (HSM).
note: >-
  [OWASP A07:2021]:Identification and Authentication Failures
  [CWE-798]: Use of Hard-coded Credentials
  [REFERENCES]
       https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
utils:
  match_property_declaration:
    kind: property_declaration
    all:
      - has:
          stopBy: end
          kind: call_expression
          has:
            stopBy: end
            kind: value_argument
            all:
              - has:
                  stopBy: end
                  kind: simple_identifier
                  field: name
                  regex: "^password$"
              - has:
                  stopBy: end
                  kind: simple_identifier
                  field: value
                  pattern: $R
      - follows:
          stopBy: end
          kind: property_declaration
          has:
            stopBy: end
            kind: pattern
            has:
              kind: simple_identifier
              pattern: $R
  match_call_expression:
    kind: call_expression
    has:
      stopBy: end
      kind: navigation_expression
      has:
        stopBy: end
        kind: value_argument
        all:
          - has:
              stopBy: end
              kind: simple_identifier
              regex: "^password$"
          - has:
              stopBy: end
              kind: line_string_literal
              has:
                stopBy: end
                kind: line_str_text
  match_call_expression_follows_property_declaration:
    kind: call_expression
    has:
      stopBy: end
      kind: navigation_expression
      all:
        - has:
            stopBy: end
            kind: call_expression
            has:
              kind: simple_identifier
              regex: "^Scrypt$"
        - has:
            stopBy: end
            kind: call_suffix
            has:
              kind: value_arguments
              all:
                - has:
                    kind: value_argument
                    all:
                      - has:
                          kind: simple_identifier
                          field: name
                          regex: "^password$"
                      - has:
                          kind: simple_identifier
                          field: value
                          pattern: $M
    follows:
      stopBy: end
      kind: property_declaration
      all:
        - has:
            stopBy: end
            kind: value_binding_pattern
            regex: "^let$"
        - has:
            stopBy: end
            kind: pattern
            field: name
            has:
              stopBy: end
              kind: simple_identifier
              field: bound_identifier
              pattern: $M
        - has:
            stopBy: end
            kind: type_annotation
        - has:
            stopBy: end
            kind: call_expression
  match_follows_line_string_literal:
    kind: call_expression
    has:
      stopBy: end
      kind: navigation_expression
      all:
        - has:
            stopBy: end
            kind: call_expression
            has:
              stopBy: end
              kind: simple_identifier
              regex: "^Scrypt$"
        - has:
            stopBy: end
            kind: call_suffix
            all:
              - has:
                  stopBy: end
                  kind: value_arguments
              - has:
                  stopBy: end
                  kind: value_argument
                  has:
                    stopBy: end
                    kind: simple_identifier
                    field: name
                    regex: "^password$"
              - has:
                  stopBy: end
                  kind: call_expression
                  has:
                    stopBy: end
                    kind: simple_identifier
                    regex: "^Array$"
              - has:
                  stopBy: end
                  kind: call_suffix
              - has:
                  stopBy: end
                  kind: value_arguments
              - has:
                  stopBy: end
                  kind: value_argument
              - has:
                  stopBy: end
                  kind: navigation_expression
                  has:
                    stopBy: end
                    kind: simple_identifier
                    pattern: $L
              - has:
                  stopBy: end
                  kind: navigation_suffix
                  has:
                    stopBy: end
                    kind: simple_identifier
                    regex: "^utf8$"
    follows:
      kind: property_declaration
      all:
        - has:
            kind: value_binding_pattern
            regex: "^let$"
        - has:
            kind: pattern
            field: name
            has:
              kind: simple_identifier
              field: bound_identifier
              pattern: $L
        - has:
            kind: line_string_literal
            field: value
            has:
              kind: line_str_text
              field: text

rule:
  any:
    - matches: match_property_declaration
    - matches: match_call_expression
    - matches: match_call_expression_follows_property_declaration
    - matches: match_follows_line_string_literal
