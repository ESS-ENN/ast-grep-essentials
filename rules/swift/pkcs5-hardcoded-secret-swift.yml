id: pkcs5-hardcoded-secret-swift
language: swift
severity: warning
message: >-
      A secret is hard-coded in the application. Secrets stored in source
      code, such as credentials, identifiers, and other types of sensitive data,
      can be leaked and used by internal or external malicious actors. Use
      environment variables to securely provide credentials and other secrets or
      retrieve them from a secure vault or Hardware Security Module (HSM).
note: >-
  [CWE-798]: Use of Hard-coded Credentials
  [REFERENCES]
       https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
utils:
    match_with_try:
        kind: call_expression
        all:
            - has:
                stopBy: end
                kind: try_expression
                all:
                - has:
                    stopBy: end
                    kind: navigation_expression
                    has:
                        stopBy: end
                        kind: simple_identifier
                        regex: '^PKCS5$'
                - has:
                    stopBy: end
                    kind: call_suffix
                    has:
                        stopBy: end
                        kind: value_argument
                        all:
                            - has:
                                stopBy: end
                                kind: simple_identifier
                                field: name
                                regex: '^password$'
                            - has:
                                field: value
                                kind: simple_identifier   
                                pattern: $R
        follows:
            stopBy: end
            kind: property_declaration
            all:
                - has:
                    stopBy: end
                    kind: value_binding_pattern    
                - has:
                    stopBy: end
                    kind: pattern
                    field: name
                    has:
                        stopBy: end
                        kind: simple_identifier
                        pattern: $R
                - has:
                    stopBy: end
                    kind: type_annotation  
                - has:
                    stopBy: end
                    kind: call_expression
            
    match_call_expression:
        kind: call_expression
        has:
            stopBy: end
            kind: navigation_expression
            all:
                - has:
                    stopBy: end
                    kind: simple_identifier
                    regex: '^PKCS5$'
                - has:
                    stopBy: end
                    kind: value_argument
                    all:
                        - has:
                            stopBy: end
                            kind: simple_identifier
                            regex: '^password$'
                        - has:
                            stopBy: end
                            kind: line_string_literal
                            has:
                                stopBy: end
                                kind: line_str_text

    match_without_try:
        kind: call_expression
        all:
        - has:
            stopBy: end
            kind: navigation_expression
            has:
                stopBy: end
                kind: simple_identifier
                regex: '^PKCS5$'
        - has:
            stopBy: end
            kind: call_suffix
            has:
                stopBy: end
                kind: value_argument
                all:
                    - has:
                        stopBy: end
                        kind: simple_identifier
                        field: name
                        regex: '^password$'
                    - has:
                        stopBy: end
                        kind: simple_identifier
                        field: value
                        pattern: $T
        - follows:
            stopBy: end
            kind: property_declaration
            all:
                - has:
                    kind: value_binding_pattern
                - has:
                   stopBy: end
                   kind: pattern
                   has:
                    stopBy: end
                    kind: simple_identifier
                    pattern: $T
                - has:
                    stopBy: end
                    kind: type_annotation
                - has:
                    stopBy: end
                    kind: call_expression     

    match_without_type_annotation:
        kind: call_expression
        all:
        - has:
            stopBy: end
            kind: navigation_expression
            has:
                stopBy: end
                kind: simple_identifier
                regex: '^PKCS5$'
        - has:
            stopBy: end
            kind: call_suffix
            has:
                stopBy: end
                kind: value_argument
                all:
                    - has:
                        stopBy: end
                        kind: simple_identifier
                        field: name
                        regex: '^password$'
                    - has:
                        stopBy: end
                        kind: simple_identifier
                        field: value
                        pattern: $T
        - follows:
            stopBy: end
            kind: property_declaration
            all:
                - has:
                    kind: value_binding_pattern
                - has:
                   stopBy: end
                   kind: pattern
                   field: name
                   has:
                    stopBy: end
                    kind: simple_identifier
                    pattern: $T
                - has:
                    stopBy: end
                    kind: call_expression
                    all:
                        - has:
                            stopBy: end
                            kind: call_suffix
                            has:
                                kind: value_arguments
                                has:
                                    stopBy: end
                                    kind: value_argument
                                    has:
                                        kind: navigation_expression
                                        all:
                                        - has:
                                            stopBy: end
                                            kind: line_string_literal 
                                        - has:
                                            stopBy: end
                                            kind: navigation_suffix 

    match_with_try_with_type_annotation:
        kind: try_expression
        all:
        - has:
            stopBy: end
            kind: call_expression
        - has:
            stopBy: end
            kind: navigation_expression
            has:
                stopBy: end
                kind: simple_identifier
                regex: '^PKCS5$'
        - has:
            stopBy: end
            kind: call_suffix
            has:
                stopBy: end
                kind: value_argument
                all:
                    - has:
                        stopBy: end
                        kind: simple_identifier
                        field: name
                        regex: '^password$'
                    - has:
                        stopBy: end
                        kind: simple_identifier
                        field: value
                        pattern: $T
        - follows:
            stopBy: end
            kind: property_declaration
            all:
                - has:
                    kind: value_binding_pattern
                - has:
                   stopBy: end
                   kind: pattern
                   field: name
                   has:
                    stopBy: end
                    kind: simple_identifier
                    pattern: $T
                - has:
                    stopBy: end
                    kind: call_expression
                    all:
                        - has:
                            stopBy: end
                            kind: call_suffix
                            has:
                                kind: value_arguments
                                has:
                                    stopBy: end
                                    kind: value_argument
                                    has:
                                        kind: navigation_expression
                                        all:
                                        - has:
                                            stopBy: end
                                            kind: line_string_literal 
                                        - has:
                                            stopBy: end
                                            kind: navigation_suffix 
    match_try_with_string:
        kind: call_expression
        all:
            - has:
                kind: navigation_expression
                all:
                    - has:
                        stopBy: end
                        kind: simple_identifier
                        regex: '^PKCS5$'
                    - has:
                        kind: navigation_suffix
                        has:
                            stopBy: end
                            kind: simple_identifier    
            - has:
                kind: call_suffix
                has:
                    kind: value_arguments
                    has:
                        kind: value_argument
                        has:
                            kind: line_string_literal

                                                                            
rule:
    any:
        - matches: match_call_expression
        - matches: match_with_try
        - matches: match_without_try
        - matches: match_without_type_annotation
        - matches: match_with_try_with_type_annotation
        - matches: match_try_with_string




