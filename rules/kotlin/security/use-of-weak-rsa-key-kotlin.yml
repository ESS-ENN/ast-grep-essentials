id: use-of-weak-rsa-key-kotlin
language: kotlin
severity: warning
message: >-
    RSA keys should be at least 2048 bits based on NIST recommendation
note: >-
  [CWE-326]: Inadequate Encryption Strength
  [OWASP A03:2017]: Sensitive Data Exposure
  [OWASP A02:2021]: Cryptographic Failures
  [REFERENCES]
      - https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html#algorithms
utils:
  match_call_expression:
    kind: call_expression
    all:
      - has:
          kind: navigation_expression
          all:
            - has:
                kind: simple_identifier
                pattern: $KEYGEN
            - has:
                kind: navigation_suffix
                has:
                  kind: simple_identifier
                  regex: "^initialize$"
      - has:
          kind: call_suffix
          has:
            kind: value_arguments
            has:
              kind: value_argument
              any:
                - has:
                    kind: integer_literal
                    pattern: $INTEGER
                - has:
                    kind: real_literal
                    pattern: $INTEGER
                - has:
                    kind: prefix_expression
                    any:
                      - has:
                          kind: integer_literal
                          pattern: $INTEGER
                      - has:
                          kind: real_literal
                          pattern: $INTEGER
      - follows:
         stopBy: end
         kind: property_declaration
         all:
         - inside:
             stopBy: end
             kind: statements
         - has:
            kind: variable_declaration
            all:
              - has:
                  kind: simple_identifier
                  pattern: $KEYGEN
              - has:
                  kind: user_type
                  has:
                    kind: type_identifier
         - has:
            kind: call_expression
            all:
              - has:
                  kind: navigation_expression
                  all:
                    - has:
                        kind: simple_identifier
                    - has:
                        kind: navigation_suffix
                        has:
                          kind: simple_identifier
              - has:
                  kind: call_suffix
                  has:
                    kind: value_arguments
                    has:
                      kind: value_argument
rule:
  any:
    - matches: match_call_expression
constraints:
  INTEGER:
    regex: '^(-?(0|[1-9][0-9]?|[1-9][0-9]{2}|1[0-9]{3}|20[0-3][0-9]|204[0-7])(\.[0-9]+)?|0|-[1-9][0-9]*|-[1-9][0-9]{2,}|-1[0-9]{3}|-20[0-3][0-9]|-204[0-7])$'
